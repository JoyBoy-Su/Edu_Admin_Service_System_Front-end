<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login</title>
    <link rel="stylesheet" href="css/login.css">
    <script src="js/jquery-1.7.2.js"></script>
    <script>
        $(function () {
            $("#login_btn").click(function () {
                //获取信息提示对象
                var msg = $("#msg");

                //获取用户输入，并初步判断信息是否合法
                var schoolNumber = $("#schoolNumber").val();
                if (schoolNumber == "") {
                    msg.text("请输入学工号!");
                    return false;
                }
                if (schoolNumber!="001" && !/^\d{6}$/.test(schoolNumber) && !/^\d{8}$/.test(schoolNumber)) {
                    msg.text("学工号不合法!");
                    return false;
                }
                var password = $("#password").val();
                if (password == "") {
                    msg.text("请输入密码!");
                    return false;
                }

                //提交登录信息
                var arr = {
                    "schoolNumber": schoolNumber,
                    "password": password
                };

                $.ajax({
                    url: "/login",
                    type: "post",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    data: JSON.stringify(arr),
                    xhrFields: {
                        withCredentials: true
                    },
                        success: function (response) {
                        var res = response;//JSON.parse(response);
                        if (res.success == "1") {
                            //设置session
                            var storage = window.sessionStorage;
                            storage.setItem("name",res.username);
                            storage.setItem("schoolNumber",res.schoolNumber);
                            storage.setItem("first_login",res.first_login);
                            storage.setItem("type",res.type);
                            //判断用户是否为第一次登录
                            if (res.first_login == "1") {
                            	alert("初次登录，请先修改密码。");
                                window.location.href = "password.html";
                            } else window.location.href = "homepage.html";
                        } else {
                            //获取后端失败的具体信息：学工号不存在/密码错误
                            msg.text("学工号或密码错误！");
                        }
                    },
                    error: function () {
                        //请求失败导致登录失败
                        msg.text("请求错误！");
                    }
                });
            })
        })
    </script>
</head>
<body>
<div class="wrapper">
    <div class="logo"><img src="picture/fudanlogo.jpg" alt=""></div>
    <div class="text-center mt-4 name"> 统一身份认证</div>
    <form class="p-3 mt-3">
        <div class="form-field d-flex align-items-center">
            <span class="far fa-user"></span>
            <input type="text" name="schoolNumber" id="schoolNumber" placeholder="学工号">
        </div>
        <div class="form-field d-flex align-items-center">
            <span class="fas fa-key"></span>
            <input type="password" name="password" id="password" placeholder="密码">
        </div>
        <button class="btn mt-3" id="login_btn" type="button">登录</button>
        <div>
            <span id="msg"></span>
        </div>
    </form>
</div>
</body>
</html>